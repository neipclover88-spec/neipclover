<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Daily Tracker</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#080b0f;--s1:#0f1318;--s2:#161b22;--s3:#1d242d;
  --bd:#232b36;--bd2:#2c3647;--txt:#d8e0ed;--muted:#55647a;--dim:#2e3a4a;
  --gold:#f0a500;--teal:#3ecfbe;--red:#e05454;--green:#3ecf6e;
  --blue:#4a9eff;--violet:#a78bfa;--orange:#f97316;
  --kor:var(--blue);--eng:var(--gold);--math:var(--green);--soc:var(--red);
}
html,body{height:100%;background:var(--bg);color:var(--txt);
  font-family:'Noto Sans KR','Apple SD Gothic Neo',sans-serif;font-size:13px;line-height:1.4;
  overflow-x:hidden}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:4px}

#loader{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:14px;z-index:9999;transition:opacity .4s}
.spin{width:34px;height:34px;border:3px solid var(--bd2);border-top-color:var(--gold);
  border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

#cfgBanner{display:none;background:#0e0800;border-bottom:2px solid var(--gold);
  padding:10px 20px;font-size:11px;color:var(--muted);line-height:1.8;z-index:200;position:relative}
#cfgBanner.show{display:block}
#cfgBanner strong{color:var(--gold)}
#cfgBanner code{background:var(--bg);padding:1px 5px;border-radius:3px;color:var(--teal);font-size:10px}
#cfgBanner button{margin-top:6px;background:var(--gold);border:none;border-radius:4px;
  padding:5px 12px;color:#000;font-weight:700;cursor:pointer;font-size:11px}

.app{display:flex;flex-direction:column;min-height:100vh;overflow-y:auto}

/* HEADER */
header{background:var(--s1);border-bottom:1px solid var(--bd);padding:0 16px;
  height:54px;display:flex;align-items:center;gap:12px;flex-shrink:0;z-index:100}
.h-dateblock{display:flex;flex-direction:column;line-height:1.1;min-width:110px}
.h-year{font-size:10px;color:var(--muted);letter-spacing:1px}
.h-month{font-size:15px;font-weight:700;color:var(--txt)}
.h-nav{display:flex;align-items:center;gap:6px}
.h-nav button{background:var(--bd);border:none;color:var(--txt);width:26px;height:26px;
  border-radius:4px;cursor:pointer;font-size:14px;transition:background .15s;
  display:flex;align-items:center;justify-content:center}
.h-nav button:hover{background:var(--gold);color:#000}
#weekRange{font-size:11px;color:var(--muted);min-width:90px;text-align:center}
.h-logo{font-size:11px;font-weight:700;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-left:4px}
.h-space{flex:1}
.h-stats{display:flex;gap:16px}
.hst{text-align:right}
.hst .v{font-size:15px;font-weight:700;color:var(--gold);display:block;line-height:1.1}
.hst .l{font-size:9px;color:var(--muted);letter-spacing:1px;display:block}
.hst.teal .v{color:var(--teal)}.hst.red .v{color:var(--red)}

/* BODY */
.body{display:grid;grid-template-columns:1fr 360px;flex:1;overflow:hidden;min-height:0}
@media(min-width:769px){
  .body{height:calc(100vh - 54px);overflow:hidden}
  .left{overflow-y:auto;height:100%}
  .right{overflow-y:auto;height:100%}
}
.left{overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px}

/* SUMMARY */
.wsummary{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.ws{background:var(--s2);border:1px solid var(--bd);border-radius:8px;padding:9px 10px}
.ws .v{font-size:18px;font-weight:700;color:var(--gold);display:block;line-height:1.1}
.ws .l{font-size:9px;color:var(--muted);letter-spacing:1px;margin-top:2px;display:block}
.ws.teal .v{color:var(--teal)}.ws.green .v{color:var(--green)}

/* CALENDAR */
.cal{background:var(--s2);border:1px solid var(--bd);border-radius:8px;padding:10px}
.dow-row{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:5px}
.dow{text-align:center;padding:6px 2px;font-size:12px;font-weight:700;letter-spacing:.5px;
  border-radius:5px;background:var(--s3)}
.dow.wd{color:var(--muted)}.dow.sat{color:var(--blue);background:rgba(74,158,255,.1)}
.dow.sun{color:var(--red);background:rgba(224,84,84,.1)}
.day-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.dc{background:var(--s3);border:1px solid var(--bd);border-radius:6px;padding:5px;
  cursor:pointer;min-height:82px;transition:border-color .15s,transform .1s;
  display:flex;flex-direction:column;gap:2px}
.dc:hover{border-color:var(--gold);transform:translateY(-1px)}
.dc.today{border-color:var(--gold)}.dc.selected{border-color:var(--teal);background:rgba(62,207,190,.04)}
.dc-num{font-size:14px;font-weight:700;color:var(--txt);line-height:1}
.dc.today .dc-num{color:var(--gold)}.dc.dc-sat .dc-num{color:rgba(74,158,255,.85)}.dc.dc-sun .dc-num{color:rgba(224,84,84,.85)}
.dc-badges{display:flex;flex-wrap:wrap;gap:2px}
.badge{font-size:7px;padding:1px 3px;border-radius:2px;font-weight:700}
.b-swim{background:rgba(62,207,190,.15);color:var(--teal)}
.b-run{background:rgba(249,115,22,.15);color:var(--orange)}
.b-bike{background:rgba(167,139,250,.15);color:var(--violet)}
.dc-rows{display:flex;flex-direction:column;gap:2px;margin-top:auto}
.dc-bars{display:flex;gap:1px;align-items:flex-end;height:14px}
.dc-bar{flex:1;border-radius:1px 1px 0 0;min-height:2px}
.dc-inc{font-size:7px;color:var(--gold);font-weight:700;line-height:1}
.dc-icons{display:flex;gap:2px;font-size:11px;line-height:1}
.dc-mood{font-size:10px;line-height:1}

/* CARD */
.card{background:var(--s2);border:1px solid var(--bd);border-radius:8px;padding:12px}
.sec-title{font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;
  margin-bottom:10px;display:flex;align-items:center;gap:8px}
.sec-title::after{content:'';flex:1;height:1px;background:var(--bd)}

/* SUBJECT ACCORDION */
.subj-accordion{display:flex;flex-direction:column;gap:6px}
.subj-item{background:var(--s3);border:1px solid var(--bd);border-radius:8px;overflow:hidden}
.subj-header{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;
  user-select:none;transition:background .15s}
.subj-header:hover{background:rgba(255,255,255,.03)}
.subj-color-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.subj-name{font-size:12px;font-weight:700;letter-spacing:.5px;flex:1}
.subj-hours-preview{font-size:11px;color:var(--muted)}
.subj-arrow{font-size:10px;color:var(--muted);transition:transform .2s}
.subj-item.open .subj-arrow{transform:rotate(90deg)}
.subj-body{display:none;padding:0 12px 12px;border-top:1px solid var(--bd)}
.subj-item.open .subj-body{display:block}
.subj-hours-row{display:flex;align-items:center;gap:8px;padding:10px 0 10px;border-bottom:1px solid var(--bd);margin-bottom:10px}
.subj-hours-row label{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;flex:1}
.subj-hours-input{width:70px!important;text-align:center;font-size:14px!important;font-weight:700!important;padding:5px!important}

/* PROJ ITEMS inside subject */
.proj-list{display:flex;flex-direction:column;gap:6px}
.proj-item{background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:8px;position:relative}
.proj-top{display:grid;grid-template-columns:1fr 56px 38px;gap:4px;margin-bottom:6px;align-items:center}
.proj-bar-wrap{height:9px;border-radius:4px;background:var(--s3);overflow:hidden;margin-bottom:5px;border:1px solid var(--bd)}
.proj-bar-fill{height:100%;border-radius:4px;transition:width .4s}
.proj-meta{display:flex;justify-content:space-between;font-size:10px;color:var(--muted)}
.proj-today-row{display:flex;align-items:center;gap:5px;margin-top:6px}
.proj-today-row label{font-size:9px;color:var(--muted);letter-spacing:1px;white-space:nowrap}
.add-proj-btn{display:flex;align-items:center;justify-content:center;gap:5px;width:100%;
  padding:7px;background:transparent;border:1px dashed var(--bd2);border-radius:5px;
  cursor:pointer;color:var(--muted);font-size:10px;font-family:inherit;margin-top:6px;transition:all .15s}
.add-proj-btn:hover{border-color:var(--gold);color:var(--gold)}
.del-btn{position:absolute;top:5px;right:5px;background:none;border:none;
  color:var(--muted);cursor:pointer;font-size:11px;opacity:.4;line-height:1}
.del-btn:hover{opacity:1;color:var(--red)}

/* always-visible project progress bar under subject header */
.subj-mini-prog{padding:0 12px 8px;display:flex;flex-direction:column;gap:3px}
.subj-mini-row{display:flex;align-items:center;gap:6px}
.subj-mini-name{font-size:9px;color:var(--muted);width:52px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.subj-mini-track{flex:1;height:5px;background:var(--bg);border-radius:3px;overflow:hidden;border:1px solid var(--bd)}
.subj-mini-fill{height:100%;border-radius:3px;transition:width .4s}
.subj-mini-pct{font-size:9px;font-weight:700;width:28px;text-align:right}
  padding-top:10px;border-top:1px solid var(--bd);margin-top:4px}
.study-total-n{font-size:22px;font-weight:700;color:var(--teal)}

/* RIGHT PANEL */
.right{background:var(--s1);border-left:1px solid var(--bd);overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.panel-date{margin-bottom:2px}
.panel-d-str{font-size:19px;font-weight:700;line-height:1.2}
.panel-d-sub{font-size:10px;color:var(--muted);letter-spacing:1px;margin-top:2px}

/* EXERCISE */
.ex-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px}
.ex-btn{background:var(--s3);border:1px solid var(--bd);border-radius:6px;padding:8px 4px;
  cursor:pointer;text-align:center;color:var(--muted);font-family:inherit;font-size:9px;
  letter-spacing:.5px;transition:all .15s}
.ex-btn .ico{font-size:17px;display:block;margin-bottom:3px}
.ex-btn:hover{border-color:var(--gold)}
.ex-btn.on-swim{border-color:var(--teal);background:rgba(62,207,190,.08);color:var(--teal)}
.ex-btn.on-run{border-color:var(--orange);background:rgba(249,115,22,.08);color:var(--orange)}
.ex-btn.on-bike{border-color:var(--violet);background:rgba(167,139,250,.08);color:var(--violet)}
.ex-detail{display:none}.ex-detail.show{display:block;margin-bottom:8px}
.ex-frow{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px}
.ex-metric{background:var(--bg);border:1px solid var(--bd);border-radius:5px;padding:7px 10px;
  display:flex;justify-content:space-between;align-items:center}
.em-l{font-size:9px;color:var(--muted);letter-spacing:1px}
.em-v{font-size:14px;font-weight:700}
.em-swim{color:var(--teal)}.em-run{color:var(--orange)}.em-bike{color:var(--violet)}
.ex-hdr{font-size:9px;font-weight:700;letter-spacing:1px;margin-bottom:6px}

/* INCOME */
.target-row{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px}
.tstat{background:var(--s3);border:1px solid var(--bd);border-radius:6px;padding:8px;text-align:center}
.tstat .v{font-size:13px;font-weight:700;color:var(--gold);display:block;line-height:1.2}
.tstat .l{font-size:8px;color:var(--muted);letter-spacing:1px;display:block;margin-top:2px}
.tstat.teal .v{color:var(--teal)}.tstat.red .v{color:var(--red)}.tstat.green .v{color:var(--green)}
.inc-inputs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px}
.wkchart{display:flex;align-items:flex-end;gap:4px;height:65px;position:relative;padding-bottom:16px}
.wkchart::after{content:'';position:absolute;bottom:15px;left:0;right:0;height:1px;background:var(--bd)}
.wk-col{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
  position:relative;height:100%;cursor:pointer}
.wk-bar{width:100%;border-radius:3px 3px 0 0;min-height:2px;transition:height .35s;position:relative}
.wk-tline{position:absolute;width:100%;height:2px;background:var(--red);opacity:.5}
.wk-lbl{position:absolute;bottom:0;font-size:7px;color:var(--muted);text-align:center;width:100%}
.achieve-row{display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:11px}
.exceed-note{font-size:10px;color:var(--green);margin-top:5px;display:none}
.exceed-note.show{display:block}

/* HOBBY ACCORDION */
.hobby-summary{display:flex;align-items:center;justify-content:space-between;
  background:var(--s3);border:1px solid var(--bd);border-radius:6px;padding:9px 12px;
  cursor:pointer;transition:background .15s;user-select:none;margin-bottom:8px}
.hobby-summary:hover{border-color:var(--violet)}
.hobby-cumul-val{font-size:18px;font-weight:700;color:var(--violet)}
.hobby-breakdown-panel{display:none;background:var(--bg);border:1px solid var(--bd);
  border-radius:6px;padding:10px;margin-bottom:8px}
.hobby-breakdown-panel.open{display:block}
.hobby-bar-row{display:grid;grid-template-columns:80px 1fr 36px;gap:6px;align-items:center;margin-bottom:6px}
.hobby-bar-row:last-child{margin-bottom:0}
.hobby-bar-name{font-size:10px;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.hobby-bar-track{background:var(--s2);border-radius:3px;height:7px;overflow:hidden}
.hobby-bar-fill{height:100%;border-radius:3px;background:var(--violet);transition:width .35s}
.hobby-bar-hrs{font-size:10px;color:var(--violet);font-weight:700;text-align:right}
.hobby-inputs{display:grid;grid-template-columns:1fr 90px;gap:6px;margin-bottom:8px}

/* MOOD */
.mood-row{display:flex;gap:4px;margin-bottom:8px}
.mood-btn{flex:1;background:var(--s3);border:1px solid var(--bd);border-radius:6px;
  padding:5px 2px;text-align:center;cursor:pointer;font-size:17px;transition:all .15s}
.mood-btn:hover{border-color:var(--gold);transform:scale(1.06)}
.mood-btn.on{border-color:var(--teal);background:rgba(62,207,190,.08)}

/* INPUTS */
.field{display:flex;flex-direction:column;gap:3px}
label{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
input[type=number],input[type=text],textarea{background:var(--bg);border:1px solid var(--bd);
  border-radius:4px;color:var(--txt);font-family:inherit;font-size:13px;
  padding:6px 8px;width:100%;outline:none;transition:border-color .15s}
input:focus,textarea:focus{border-color:var(--teal)}
input::placeholder,textarea::placeholder{color:var(--dim)}

.save-btn{width:100%;padding:12px;background:var(--gold);border:none;border-radius:6px;
  color:#000;font-family:inherit;font-size:13px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;cursor:pointer;transition:opacity .15s,transform .1s}
.save-btn:hover{opacity:.85}.save-btn:active{transform:scale(.98)}
.save-btn:disabled{opacity:.35;cursor:not-allowed}
.save-status{text-align:center;font-size:10px;color:var(--teal);height:14px;margin-top:4px;letter-spacing:1px}

/* MOBILE â€” single column, all visible, no slide-up */
@media(max-width:768px){
  header{padding:0 10px;height:auto;min-height:48px;flex-wrap:wrap;gap:6px;padding:8px 10px}
  .h-logo{display:none}
  .h-stats{gap:10px;flex-wrap:wrap}
  .hst .v{font-size:12px}
  .body{grid-template-columns:1fr;overflow-y:auto;height:auto}
  .left{padding:10px}
  .right{
    border-left:none;border-top:1px solid var(--bd);
    padding:10px;
    min-height:auto;
    overflow-y:visible;
  }
  .wsummary{grid-template-columns:repeat(2,1fr)}
  .inc-inputs{grid-template-columns:1fr 1fr}
}
/* overlay only used on desktop for nothing â€” remove it entirely */
#overlay{display:none!important}
.fab{display:none!important}
</style>
</head>
<body>
<div id="loader"><div class="spin"></div><p style="font-size:10px;color:var(--muted);letter-spacing:3px">LOADING</p></div>
<div id="cfgBanner">
  <strong>âš™ï¸ Firebase ë¯¸ì„¤ì •</strong> â€” í˜„ì¬ <strong>ë¡œì»¬ ëª¨ë“œ</strong>ë¡œ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤ (ê¸°ê¸°ê°„ ë™ê¸°í™” ì—†ìŒ).<br>
  íŒŒì¼ í•˜ë‹¨ <code>FIREBASE_CONFIG</code> ê°’ì„ ë³¸ì¸ Firebase í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ êµì²´í•˜ë©´ ì–´ëŠ ê¸°ê¸°ì—ì„œë‚˜ ë™ê¸°í™”ë©ë‹ˆë‹¤.
  <br><button onclick="document.getElementById('cfgBanner').classList.remove('show')">í™•ì¸ (ë¡œì»¬ ìœ ì§€)</button>
</div>
<div id="overlay" onclick="closePanel()"></div>

<div class="app">
<header>
  <div class="h-dateblock">
    <span class="h-year" id="hYear"></span>
    <span class="h-month" id="hMonth"></span>
  </div>
  <div class="h-nav">
    <button onclick="prevWeek()">â€¹</button>
    <div id="weekRange"></div>
    <button onclick="nextWeek()">â€º</button>
  </div>
  <div class="h-logo">â—ˆ DAILY</div>
  <div class="h-space"></div>
  <div class="h-stats">
    <div class="hst"><span class="v" id="hTarget">â€”</span><span class="l">ì˜¤ëŠ˜ ëª©í‘œ</span></div>
    <div class="hst teal"><span class="v" id="hPaid">â‚©0</span><span class="l">3/1~ ëˆ„ì </span></div>
    <div class="hst red"><span class="v" id="hRemain">â€”</span><span class="l">ë‚¨ì€ ëª©í‘œì•¡</span></div>
  </div>
</header>

<div class="body">
<!-- â•â• LEFT â•â• -->
<div class="left">

  <div class="wsummary">
    <div class="ws teal"><span class="v" id="ws-study">0h</span><span class="l">ì£¼ê°„ ê³µë¶€</span></div>
    <div class="ws"><span class="v" id="ws-income">-</span><span class="l">ì£¼ê°„ ìˆ˜ì…</span></div>
    <div class="ws green"><span class="v" id="ws-achieve">0%</span><span class="l">ì£¼ê°„ ë‹¬ì„±ë¥ </span></div>
    <div class="ws"><span class="v" id="ws-work">0h</span><span class="l">ì£¼ê°„ ì—…ë¬´</span></div>
  </div>

  <!-- ìº˜ë¦°ë” (ì›”ìš”ì¼ ì‹œì‘) -->
  <div class="cal">
    <div class="dow-row">
      <div class="dow wd">ì›”</div><div class="dow wd">í™”</div><div class="dow wd">ìˆ˜</div>
      <div class="dow wd">ëª©</div><div class="dow wd">ê¸ˆ</div>
      <div class="dow sat">í† </div><div class="dow sun">ì¼</div>
    </div>
    <div class="day-grid" id="dayGrid"></div>
  </div>

  <!-- ê³µë¶€ ì‹œê°„ Â· ê³¼ëª©ë³„ ì•„ì½”ë””ì–¸ -->
  <div class="card">
    <div class="sec-title">ğŸ“š ê³µë¶€ Â· í•™ìŠµ ëª©í‘œ</div>
    <div class="subj-accordion" id="subjAccordion">
      <!-- JSë¡œ ë Œë”ë§ -->
    </div>
    <div class="study-footer">
      <div>
        <span class="study-total-n" id="studyTotal">0<span style="font-size:11px;color:var(--muted);font-weight:400">h</span></span>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">ì´ ê³µë¶€ì‹œê°„</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:9px;color:var(--muted);letter-spacing:1px">ì˜¤ëŠ˜ ë‹¬ì„±ë¥ </div>
        <div style="font-size:18px;font-weight:700;color:var(--teal)" id="studyPct">-</div>
      </div>
    </div>
  </div>

</div><!-- /left -->

<!-- â•â• RIGHT â•â• -->
<div class="right" id="rightPanel">
  <div class="panel-date">
    <div class="panel-d-str" id="panelDStr">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="panel-d-sub" id="panelDSub">ìº˜ë¦°ë”ì˜ ë‚ ì§œë¥¼ í´ë¦­í•˜ì„¸ìš”</div>
  </div>

  <!-- ìš´ë™ -->
  <div class="card">
    <div class="sec-title">ğŸƒ ìš´ë™</div>
    <div class="ex-btns">
      <button class="ex-btn" id="exSwim" onclick="toggleEx('swim')"><span class="ico">ğŸŠ</span>ìˆ˜ì˜</button>
      <button class="ex-btn" id="exRun"  onclick="toggleEx('run')"><span class="ico">ğŸƒ</span>ëŸ¬ë‹</button>
      <button class="ex-btn" id="exBike" onclick="toggleEx('bike')"><span class="ico">ğŸš´</span>ìì „ê±°</button>
    </div>
    <div class="ex-detail" id="det-swim">
      <div class="ex-hdr" style="color:var(--teal)">ğŸŠ ìˆ˜ì˜</div>
      <div class="ex-frow">
        <div class="field"><label>ë°”í€´ ìˆ˜ (laps)</label><input type="number" id="swimLaps" placeholder="0" min="0" oninput="calcSwim();autoSave()"></div>
        <div class="field"><label>ì‹œê°„ (ë¶„)</label><input type="number" id="swimMin" placeholder="0" min="0" oninput="calcSwim();autoSave()"></div>
      </div>
      <div class="ex-metric"><span class="em-l">ë© í˜ì´ìŠ¤</span><span class="em-v em-swim" id="swimMetric">â€”</span></div>
    </div>
    <div class="ex-detail" id="det-run">
      <div class="ex-hdr" style="color:var(--orange)">ğŸƒ ëŸ¬ë‹</div>
      <div class="ex-frow">
        <div class="field"><label>ê±°ë¦¬ (km)</label><input type="number" id="runKm" placeholder="0.0" min="0" step="0.1" oninput="calcRun();autoSave()"></div>
        <div class="field"><label>ì‹œê°„ (ë¶„)</label><input type="number" id="runMin" placeholder="0" min="0" oninput="calcRun();autoSave()"></div>
      </div>
      <div class="ex-metric"><span class="em-l">km í˜ì´ìŠ¤</span><span class="em-v em-run" id="runMetric">â€”</span></div>
    </div>
    <div class="ex-detail" id="det-bike">
      <div class="ex-hdr" style="color:var(--violet)">ğŸš´ ìì „ê±°</div>
      <div class="ex-frow">
        <div class="field"><label>ê±°ë¦¬ (km)</label><input type="number" id="bikeKm" placeholder="0.0" min="0" step="0.1" oninput="calcBike();autoSave()"></div>
        <div class="field"><label>ì‹œê°„ (ë¶„)</label><input type="number" id="bikeMin" placeholder="0" min="0" oninput="calcBike();autoSave()"></div>
      </div>
      <div class="ex-metric"><span class="em-l">í‰ê·  ì†ë„</span><span class="em-v em-bike" id="bikeMetric">â€”</span></div>
    </div>
  </div>

  <!-- ì—…ë¬´Â·ìˆ˜ì… -->
  <div class="card">
    <div class="sec-title">ğŸ’° ì—…ë¬´ Â· ìˆ˜ì…</div>
    <div class="target-row">
      <div class="tstat"><span class="v" id="tDynamic">â€”</span><span class="l">ì˜¤ëŠ˜ ëª©í‘œ</span></div>
      <div class="tstat teal"><span class="v" id="tEarned">â‚©0</span><span class="l">ì˜¤ëŠ˜ ìˆœìˆ˜ì…</span></div>
      <div class="tstat red"><span class="v" id="tGap">â€”</span><span class="l" id="tGapLbl">ì´ë²ˆë‹¬ ë¶€ì¡±</span></div>
    </div>
    <!-- ëª©í‘œ ê³„ì‚° ì•ˆë‚´ -->
    <div style="background:var(--bg);border:1px solid var(--bd);border-radius:5px;padding:7px 10px;margin-bottom:10px;font-size:10px;color:var(--muted);line-height:1.9">
      <span style="color:var(--gold)">ì¼ì¼ ëª©í‘œë¶„</span> = ì”ì•¡(<span id="infoRemDebt" style="color:var(--gold)">â€”</span>) Ã· ë‚¨ì€ì¼ìˆ˜(<span id="infoRemDays" style="color:var(--gold)">â€”</span>ì¼)&nbsp;
      <span style="float:right;color:var(--teal)">ì´ë²ˆë‹¬ ëª©í‘œ <strong id="infoMonthTgt" style="color:var(--teal)">â€”</strong></span>
    </div>
    <div class="inc-inputs">
      <div class="field"><label>ìˆ˜ì… (ì›)</label><input type="number" id="todayIncome" placeholder="0" oninput="onIncome()"></div>
      <div class="field"><label>ì§€ì¶œ (ì›)</label><input type="number" id="todayExpense" placeholder="0" oninput="onIncome()"></div>
      <div class="field"><label>ì—…ë¬´ ì‹œê°„</label><input type="number" id="workHours" placeholder="0" min="0" step="0.5" oninput="autoSave()"></div>
    </div>
    <div style="font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:4px">ì´ë²ˆì£¼ ì¼ë³„ ìˆ˜ì…</div>
    <div class="wkchart" id="wkChart"></div>
    <div class="achieve-row">
      <span style="color:var(--muted)">ì˜¤ëŠ˜ ë‹¬ì„±ë¥ </span>
      <span style="font-weight:700;color:var(--gold)" id="achPct">0%</span>
    </div>
    <div style="background:var(--bg);border:1px solid var(--bd);border-radius:3px;height:7px;margin-top:4px;overflow:hidden">
      <div id="achBar" style="background:var(--gold);height:100%;width:0%;border-radius:3px;transition:width .35s"></div>
    </div>
    <div class="exceed-note" id="exceedNote">âœ… ëª©í‘œ ì´ˆê³¼! ì‰ì—¬ë¶„ì´ ëª©í‘œì•¡ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤</div>
  </div>

  <!-- ì·¨ë¯¸ -->
  <div class="card">
    <div class="sec-title">ğŸ® ì·¨ë¯¸</div>
    <!-- ì˜¤ëŠ˜ ì…ë ¥ -->
    <div class="hobby-inputs">
      <div class="field"><label>ì˜¤ëŠ˜ ì·¨ë¯¸</label><input type="text" id="hobbyName" placeholder="ë…ì„œ, ê²Œì„, ê·¸ë¦¼..." oninput="autoSave()"></div>
      <div class="field"><label>ì˜¤ëŠ˜ (h)</label><input type="number" id="hobbyHours" placeholder="0" min="0" step="0.5" oninput="autoSave()"></div>
    </div>
    <!-- ëˆ„ì  ìš”ì•½ (í´ë¦­í•˜ë©´ í¼ì³ì§) -->
    <div class="hobby-summary" id="hobbySummaryToggle" onclick="toggleHobbyBreakdown()">
      <div>
        <div style="font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:2px">3/1 ì´í›„ ëˆ„ì </div>
        <span class="hobby-cumul-val" id="hobbyCumul">0h</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted)">
        ì·¨ë¯¸ë³„ ë³´ê¸° <span id="hobbyArrow" style="transition:transform .2s">â–¶</span>
      </div>
    </div>
    <!-- ì·¨ë¯¸ë³„ ë°” ì°¨íŠ¸ íŒ¨ë„ -->
    <div class="hobby-breakdown-panel" id="hobbyBreakdownPanel"></div>
  </div>

  <!-- ê°ì • ê¸°ë¡ -->
  <div class="card">
    <div class="sec-title">ğŸ’­ ì˜¤ëŠ˜ ê¸°ë¡</div>
    <div class="mood-row">
      <button class="mood-btn" id="mood1" onclick="setMood(1)">ğŸ˜</button>
      <button class="mood-btn" id="mood2" onclick="setMood(2)">ğŸ˜•</button>
      <button class="mood-btn" id="mood3" onclick="setMood(3)">ğŸ˜</button>
      <button class="mood-btn" id="mood4" onclick="setMood(4)">ğŸ™‚</button>
      <button class="mood-btn" id="mood5" onclick="setMood(5)">ğŸ˜„</button>
    </div>
    <textarea id="noteText" placeholder="ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼, ëŠë‚€ ì , ë©”ëª¨..."
      style="resize:none;height:72px;font-size:12px" oninput="autoSave()"></textarea>
  </div>

  <button class="save-btn" id="saveBtn" onclick="saveRecord()" disabled>ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</button>
  <div class="save-status" id="saveStatus"></div>
</div><!-- /right -->
</div><!-- /body -->
</div><!-- /app -->
<button class="fab" onclick="togglePanel()">âœï¸</button>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  FIREBASE CONFIG
  Firebase Console â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì›¹ ì•± ì¶”ê°€
  ì•„ë˜ ê°’ì„ ë³¸ì¸ í”„ë¡œì íŠ¸ë¡œ êµì²´í•˜ì„¸ìš”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC59lvF_LFGum04mc6zER-2GFWxQjQVc9U",
  authDomain: "dashboard-b71bb.firebaseapp.com",
  projectId: "dashboard-b71bb",
  storageBucket: "dashboard-b71bb.firebasestorage.app",
  messagingSenderId: "528755986354",
  appId: "1:528755986354:web:3f2b81b01be9cdd24a1eab",
  measurementId: "G-E2CCM15KTM"
};

/* â•â•â•â• ì¬ë¬´ ìƒìˆ˜ â•â•â•â•
   ìƒí™˜ëª©í‘œ = 1,500ë§Œ Ã— 1.08 = 1,620ë§Œ  â† í—¤ë” "ë‚¨ì€ ëª©í‘œì•¡"ì— í‘œì‹œ
   ê³ ì •ë¹„   = ì›” 100ë§Œ / ì¼í•  ê³„ì‚°      â† ì˜¤ëŠ˜ ëª©í‘œì—ë§Œ ì¶”ê°€, ì´ì•¡ì— ë¯¸í¬í•¨
   ì˜¤ëŠ˜ëª©í‘œ = ceil(ë‚¨ì€ìƒí™˜ëª©í‘œ/ë‚¨ì€ì¼ìˆ˜) + round(100ë§Œ/30)
*/
/* â•â•â•â• ì¬ë¬´ ìƒìˆ˜ â•â•â•â•
   DEBT_GOAL  = 15,000,000 Ã— 1.08 = 16,200,000  (ì´ì í¬í•¨)
   ê¸°ê°„       = 2026-03-01 ~ 2027-03-01 (365ì¼)
   ì¼ì¼ ì±„ë¬´ë¶„ = ceil(ë‚¨ì€ì±„ë¬´ / ë‚¨ì€ì¼ìˆ˜)
   ì¼ì¼ ê³ ì •ë¹„ = 1,000,000 / í•´ë‹¹ì›”_ì¼ìˆ˜  (ì›”ë§ˆë‹¤ ë‹¤ë¦„)
   ì˜¤ëŠ˜ëª©í‘œ   = ì¼ì¼ì±„ë¬´ë¶„ + ì¼ì¼ê³ ì •ë¹„
   ë¶€ì¡±/ì´ˆê³¼  = ì´ë²ˆë‹¬ ìˆ˜ì…í•©ê³„ vs ì´ë²ˆë‹¬ ëª©í‘œ  (ì›”ë³„ ê¸°ì¤€)
*/
const PRINCIPAL    = 15_000_000;
const RATE         = 0.08;
const DEBT_GOAL    = Math.round(PRINCIPAL * (1 + RATE)); // 16,200,000
const MONTHLY_FIX  = 1_000_000;
const START_STR    = '2026-03-01';
const START_DATE   = new Date('2026-03-01T00:00:00');
const END_DATE     = new Date('2027-03-01T23:59:59');
const TOTAL_DAYS   = 365;

function daysInMonth(date) {
  return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
}
function dailyFix(date) {
  return Math.round(MONTHLY_FIX / daysInMonth(date));
}


/* ê³¼ëª© ì •ì˜ */
const SUBJECTS = [
  { id:'kor',  name:'êµ­ì–´', color:'var(--kor)',  hex:'#4a9eff' },
  { id:'math', name:'ìˆ˜í•™', color:'var(--math)', hex:'#3ecf6e' },
  { id:'eng',  name:'ì˜ì–´', color:'var(--eng)',  hex:'#f0a500' },
  { id:'soc',  name:'ì‚¬íƒ', color:'var(--soc)',  hex:'#e05454' },
];

/* â•â•â•â• STATE â•â•â•â• */
let db = null, localMode = false;
let curDate = null, wkOffset = 0, weekData = {};
let allTimeIncome = 0, allTimeExpenses = 0;
let subjectProjects = { kor:[], eng:[], math:[], soc:[] }; // {id,name,unit,total}[]
let projCumul = {};       // {projId: cumulative}
let hobbyCumul = 0, hobbyBreakdown = {};
let exOn = { swim:false, run:false, bike:false };
let mood = 0, asTimer = null;
let dynTarget = Math.ceil(DEBT_GOAL / TOTAL_DAYS) + dailyFix(new Date());

/* â•â•â•â• FIREBASE â•â•â•â• */
function initFB() {
  try {
    if (FIREBASE_CONFIG.apiKey === 'YOUR_API_KEY') throw 'local';
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
  } catch(_) {
    localMode = true;
    document.getElementById('cfgBanner').classList.add('show');
  }
}
async function dbGet(k) {
  if (localMode) { const r = localStorage.getItem(k); return r ? JSON.parse(r) : null; }
  const s = await db.collection('tracker').doc(k).get();
  return s.exists ? s.data() : null;
}
async function dbSet(k, v) {
  if (localMode) { localStorage.setItem(k, JSON.stringify(v)); return; }
  await db.collection('tracker').doc(k).set(v);
}
async function dbGetMany(keys) {
  const out = {};
  if (localMode) {
    for (const k of keys) { const r = localStorage.getItem(k); if (r) out[k] = JSON.parse(r); }
    return out;
  }
  const snaps = await Promise.all(keys.map(k => db.collection('tracker').doc(k).get()));
  for (let i = 0; i < keys.length; i++) if (snaps[i].exists) out[keys[i]] = snaps[i].data();
  return out;
}
async function dbGetAllDay() {
  const out = {};
  if (localMode) {
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k.startsWith('d:')) out[k] = JSON.parse(localStorage.getItem(k));
    }
    return out;
  }
  const s = await db.collection('tracker').where('_type','==','day').get();
  s.forEach(d => { out['d:' + d.id] = d.data(); });
  return out;
}

/* â•â•â•â• DATE UTILS â•â•â•â• */
function toStr(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function today() { return toStr(new Date()); }

/* Monday-first week */
function getWeekDates(off = 0) {
  const now = new Date(), dow = now.getDay();
  const mon = new Date(now);
  mon.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1) + off * 7);
  return Array.from({length:7}, (_, i) => {
    const d = new Date(mon); d.setDate(mon.getDate() + i); return toStr(d);
  });
}

function krw(n) { return 'â‚©' + (Math.round(n) || 0).toLocaleString('ko-KR'); }
function secToMS(s) {
  const m = Math.floor(s / 60), sec = Math.round(s % 60);
  return m + "'" + String(sec).padStart(2, '0') + '"';
}

/* â•â•â•â• DYNAMIC TARGET â•â•â•â• */
function calcDynTarget() {
  const now      = new Date();
  const remDays  = Math.max(1, Math.ceil((END_DATE - now) / 86400000));
  // ìˆœ ìƒí™˜ë¶„ = ìˆ˜ì… - ì§€ì¶œ (ê³ ì •ë¹„ëŠ” ë³„ë„, ì±„ë¬´ ì”ì•¡ì— ë°˜ì˜ ì•ˆ í•¨)
  const netRepaid = Math.max(0, allTimeIncome - allTimeExpenses);
  const remDebt   = Math.max(0, DEBT_GOAL - netRepaid);
  return Math.ceil(remDebt / remDays) + dailyFix(now);
}
function remainingDebt() {
  const netRepaid = Math.max(0, allTimeIncome - allTimeExpenses);
  return Math.max(0, DEBT_GOAL - netRepaid);
}
// ì´ë²ˆë‹¬ ëª©í‘œ = ì¼ì¼ì±„ë¬´ë¶„ Ã— ì´ë²ˆë‹¬ì¼ìˆ˜ + ì›”ê³ ì •ë¹„
function monthlyTarget() {
  const now = new Date();
  const dim  = daysInMonth(now);
  const remDays = Math.max(1, Math.ceil((END_DATE - now) / 86400000));
  const netRepaid = Math.max(0, allTimeIncome - allTimeExpenses);
  const remDebt   = Math.max(0, DEBT_GOAL - netRepaid);
  const dailyDebt = Math.ceil(remDebt / remDays);
  return dailyDebt * dim + MONTHLY_FIX;
}
// ì´ë²ˆë‹¬ 1ì¼~ì˜¤ëŠ˜ê¹Œì§€ ëˆ„ì  ìˆ˜ì… (allTimeRec ìºì‹œ ì‚¬ìš©)
let _allRec = {};
function monthlyIncomeSoFar() {
  const ym = toStr(new Date()).slice(0, 7);
  let sum = 0;
  for (const k in _allRec) {
    if (k.replace('d:','').startsWith(ym)) sum += (_allRec[k].income || 0);
  }
  return sum;
}


/* â•â•â•â• ALL-TIME DATA â•â•â•â• */
async function loadAllTime() {
  const all = await dbGetAllDay();
  _allRec = all;  // cache for monthly calc
  allTimeIncome = 0; allTimeExpenses = 0;
  hobbyCumul = 0; hobbyBreakdown = {}; projCumul = {};

  for (const k in all) {
    const r = all[k];
    const ds = k.replace('d:', '');
    if (ds < START_STR) continue;
    allTimeIncome   += (r.income   || 0);
    allTimeExpenses += (r.expense  || 0);
    hobbyCumul      += (r.hobbyHours || 0);
    if (r.hobbyName && r.hobbyHours) {
      hobbyBreakdown[r.hobbyName] = (hobbyBreakdown[r.hobbyName] || 0) + r.hobbyHours;
    }
    if (r.projProgress) {
      for (const id in r.projProgress) {
        projCumul[id] = (projCumul[id] || 0) + (r.projProgress[id] || 0);
      }
    }
  }
  dynTarget = calcDynTarget();
  updateHeaderStats();
  updateHobbyDisplay();
}

function updateHeaderStats() {
  const remD = remainingDebt();
  const remDays = Math.max(1, Math.ceil((END_DATE - new Date()) / 86400000));
  document.getElementById('hTarget').textContent  = krw(dynTarget);
  document.getElementById('hPaid').textContent    = krw(allTimeIncome);
  document.getElementById('hRemain').textContent  = krw(remD);
  document.getElementById('tDynamic').textContent = krw(dynTarget);
  // info line
  const rd = document.getElementById('infoRemDebt');
  const rdays = document.getElementById('infoRemDays');
  const mtgt  = document.getElementById('infoMonthTgt');
  if (rd)    rd.textContent    = krw(remD);
  if (rdays) rdays.textContent = remDays;
  if (mtgt)  mtgt.textContent  = krw(monthlyTarget());
}

/* â•â•â•â• SUBJECT PROJECTS â•â•â•â• */
async function loadSubjectProjects() {
  const p = await dbGet('subjProjects');
  if (p) subjectProjects = p;
  renderSubjectAccordion();
}
async function saveSubjectProjects() {
  await dbSet('subjProjects', subjectProjects);
  renderSubjectAccordion();
}
function addProjectToSubj(subjId) {
  if (subjectProjects[subjId].length >= 5) return;
  subjectProjects[subjId].push({ id: 'p' + Date.now(), name: '', unit: '', total: 0 });
  saveSubjectProjects();
}
function delProjectFromSubj(subjId, projId) {
  subjectProjects[subjId] = subjectProjects[subjId].filter(p => p.id !== projId);
  saveSubjectProjects();
  loadAllTime();
}
function updateSubjProj(subjId, projId, field, val) {
  const p = subjectProjects[subjId].find(x => x.id === projId);
  if (p) { p[field] = val; saveSubjectProjects(); }
}

function renderSubjectAccordion() {
  const acc = document.getElementById('subjAccordion');
  // preserve open states
  const openState = {};
  acc.querySelectorAll('.subj-item').forEach(el => {
    openState[el.dataset.subj] = el.classList.contains('open');
  });

  acc.innerHTML = '';
  let totalHours = 0, totalGoalH = 0;

  for (const subj of SUBJECTS) {
    const r = curDate ? (weekData['d:' + curDate] || {}) : {};
    const hoursVal = r['s' + subj.id.charAt(0).toUpperCase() + subj.id.slice(1)] || 0;
    totalHours += hoursVal;

    const isOpen = openState[subj.id] !== undefined ? openState[subj.id] : false;

    const item = document.createElement('div');
    item.className = 'subj-item' + (isOpen ? ' open' : '');
    item.dataset.subj = subj.id;

    // Header
    const hdr = document.createElement('div');
    hdr.className = 'subj-header';
    hdr.innerHTML = `
      <div class="subj-color-dot" style="background:${subj.hex}"></div>
      <span class="subj-name" style="color:${subj.color}">${subj.name}</span>
      <span class="subj-hours-preview" id="prev-${subj.id}">${hoursVal > 0 ? hoursVal + 'h' : ''}</span>
      <span class="subj-arrow">â–¶</span>`;
    hdr.onclick = () => item.classList.toggle('open');

    // Always-visible mini project progress bars
    const miniProg = document.createElement('div');
    miniProg.className = 'subj-mini-prog';
    const projs = subjectProjects[subj.id] || [];
    if (projs.length > 0) {
      for (const p of projs) {
        const cumul = projCumul[p.id] || 0;
        const pct = p.total > 0 ? Math.min(100, Math.round((cumul / p.total) * 100)) : 0;
        const row = document.createElement('div');
        row.className = 'subj-mini-row';
        row.innerHTML = `
          <span class="subj-mini-name" title="${p.name || 'ë¯¸ì„¤ì •'}">${p.name || 'â€”'}</span>
          <div class="subj-mini-track"><div class="subj-mini-fill" style="background:${subj.hex};width:${pct}%"></div></div>
          <span class="subj-mini-pct" style="color:${subj.hex}">${pct}%</span>`;
        miniProg.appendChild(row);
      }
    } else {
      miniProg.innerHTML = `<span style="font-size:9px;color:var(--dim)">ëª©í‘œ ì—†ìŒ â€” í´ë¦­í•´ì„œ ì¶”ê°€</span>`;
    }

    // Body
    const body = document.createElement('div');
    body.className = 'subj-body';
    body.innerHTML = `
      <div class="subj-hours-row">
        <label>ì˜¤ëŠ˜ ê³µë¶€ì‹œê°„</label>
        <input type="number" class="subj-hours-input" id="s-${subj.id}"
          placeholder="0" min="0" max="24" step="0.5"
          value="${hoursVal || ''}"
          oninput="onStudyH('${subj.id}')">
        <span style="font-size:11px;color:var(--muted);margin-left:4px">h</span>
      </div>
      <div style="font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:6px">í•™ìŠµ ëª©í‘œ ì§„ì²™</div>
      <div class="proj-list" id="pl-${subj.id}"></div>
      <button class="add-proj-btn" onclick="addProjectToSubj('${subj.id}')">+ ëª©í‘œ ì¶”ê°€</button>`;

    item.appendChild(hdr);
    item.appendChild(miniProg);
    item.appendChild(body);
    acc.appendChild(item);

    // Render projects inside this subject
    renderSubjProjList(subj, body.querySelector('.proj-list'));
  }

  // Update total
  const s = document.getElementById('studyTotal');
  if (s) s.innerHTML = totalHours.toFixed(1) + '<span style="font-size:11px;color:var(--muted);font-weight:400">h</span>';
}

function renderSubjProjList(subj, listEl) {
  listEl.innerHTML = '';
  const projs = subjectProjects[subj.id] || [];
  const colors = ['#e05454','#4a9eff','#3ecf6e','#a78bfa','#f97316'];

  for (let idx = 0; idx < projs.length; idx++) {
    const p = projs[idx];
    const c = colors[idx % colors.length];
    const cumul = projCumul[p.id] || 0;
    const pct = p.total > 0 ? Math.min(100, Math.round((cumul / p.total) * 100)) : 0;

    const div = document.createElement('div');
    div.className = 'proj-item';
    div.innerHTML = `
      <button class="del-btn" onclick="delProjectFromSubj('${subj.id}','${p.id}')">âœ•</button>
      <div class="proj-top">
        <input type="text" placeholder="ëª©í‘œëª…" value="${p.name || ''}"
          style="font-size:11px;font-weight:600"
          onchange="updateSubjProj('${subj.id}','${p.id}','name',this.value)">
        <input type="number" placeholder="ì „ì²´ëŸ‰" value="${p.total || ''}" min="0"
          style="font-size:11px"
          onchange="updateSubjProj('${subj.id}','${p.id}','total',+this.value)">
        <input type="text" placeholder="ë‹¨ìœ„" value="${p.unit || ''}"
          style="font-size:11px"
          onchange="updateSubjProj('${subj.id}','${p.id}','unit',this.value)">
      </div>
      <div class="proj-bar-wrap">
        <div class="proj-bar-fill" style="background:${c};width:${pct}%"></div>
      </div>
      <div class="proj-meta">
        <span>ëˆ„ì  <strong style="color:${c}">${cumul}</strong> / ${p.total || '?'} ${p.unit || ''}</span>
        <span style="color:${c};font-weight:700">${pct}%</span>
      </div>
      <div class="proj-today-row">
        <label>ì˜¤ëŠ˜ ë‹¬ì„±:</label>
        <input type="number" id="pp-${p.id}" placeholder="0" min="0"
          style="width:65px;font-size:12px" oninput="autoSave()">
        <span style="font-size:10px;color:var(--muted)">${p.unit || ''}</span>
      </div>`;
    listEl.appendChild(div);

    // Fill today's progress
    if (curDate) {
      const rec = weekData['d:' + curDate] || {};
      const inp = div.querySelector('#pp-' + p.id);
      if (inp && rec.projProgress) inp.value = rec.projProgress[p.id] || '';
    }
  }
}

/* â•â•â•â• RENDER WEEK â•â•â•â• */
async function renderWeek() {
  const dates = getWeekDates(wkOffset);
  const first = new Date(dates[0]), last = new Date(dates[6]);
  const fmt = d => `${d.getMonth()+1}/${d.getDate()}`;
  const mN = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];

  document.getElementById('hYear').textContent = first.getFullYear() + 'ë…„';
  document.getElementById('hMonth').textContent =
    first.getMonth() === last.getMonth() ? mN[first.getMonth()] : mN[first.getMonth()] + ' Â· ' + mN[last.getMonth()];
  document.getElementById('weekRange').textContent = `${fmt(first)} â€“ ${fmt(last)}`;

  weekData = await dbGetMany(dates.map(d => 'd:' + d));
  await loadAllTime();

  // weekly summary
  let wInc = 0, wStudy = 0, wWork = 0;
  for (const d of dates) {
    const r = weekData['d:' + d]; if (!r) continue;
    wInc   += (r.income || 0);
    wWork  += (r.workHours || 0);
    wStudy += (r.sKor||0)+(r.sEng||0)+(r.sMath||0)+(r.sSoc||0);
  }
  document.getElementById('ws-study').textContent   = wStudy.toFixed(1) + 'h';
  document.getElementById('ws-income').textContent  = krw(wInc);
  document.getElementById('ws-achieve').textContent = Math.round((wInc / (dynTarget * 7)) * 100) + '%';
  document.getElementById('ws-work').textContent    = wWork.toFixed(1) + 'h';

  renderCalendar(dates);
  renderWkChart(dates);
  renderSubjectAccordion();
}
function prevWeek() { wkOffset--; renderWeek(); }
function nextWeek() { wkOffset++; renderWeek(); }

/* â•â•â•â• CALENDAR â•â•â•â• */
function renderCalendar(dates) {
  const grid = document.getElementById('dayGrid');
  grid.innerHTML = '';
  const td = today();

  for (const ds of dates) {
    const r = weekData['d:' + ds] || {};
    const d = new Date(ds);
    const dow = d.getDay(); // 0=Sun,6=Sat

    const card = document.createElement('div');
    card.className = 'dc'
      + (ds === td ? ' today' : '')
      + (ds === curDate ? ' selected' : '')
      + (dow === 6 ? ' dc-sat' : dow === 0 ? ' dc-sun' : '');
    card.onclick = () => selectDay(ds);

    // Date number
    const num = document.createElement('div');
    num.className = 'dc-num';
    num.textContent = d.getDate();
    card.appendChild(num);

    // Exercise badges
    if (r.exOn && (r.exOn.swim || r.exOn.run || r.exOn.bike)) {
      const bd = document.createElement('div'); bd.className = 'dc-badges';
      if (r.exOn.swim) bd.innerHTML += '<span class="badge b-swim">ğŸŠ</span>';
      if (r.exOn.run)  bd.innerHTML += '<span class="badge b-run">ğŸƒ</span>';
      if (r.exOn.bike) bd.innerHTML += '<span class="badge b-bike">ğŸš´</span>';
      card.appendChild(bd);
    }

    // Bottom rows: bars + icons
    const rows = document.createElement('div');
    rows.className = 'dc-rows';

    // Study mini bars
    const tot = (r.sKor||0)+(r.sEng||0)+(r.sMath||0)+(r.sSoc||0);
    if (tot > 0) {
      const bars = document.createElement('div'); bars.className = 'dc-bars';
      [{v:r.sKor||0,c:'var(--kor)'},{v:r.sEng||0,c:'var(--eng)'},{v:r.sMath||0,c:'var(--math)'},{v:r.sSoc||0,c:'var(--soc)'}].forEach(({v,c}) => {
        const b = document.createElement('div'); b.className = 'dc-bar';
        b.style.cssText = `background:${c};height:${Math.max(2, Math.round((v/tot)*13))}px`;
        bars.appendChild(b);
      });
      rows.appendChild(bars);
    }

    // Income + work + mood icons row
    const icons = document.createElement('div'); icons.className = 'dc-icons';
    if (r.income) {
      const e = document.createElement('span');
      e.style.cssText = 'font-size:7px;color:var(--gold);font-weight:700';
      e.textContent = krw(r.income);
      icons.appendChild(e);
    }
    // Work emoji when workHours > 0
    if (r.workHours > 0) {
      const w = document.createElement('span');
      w.title = `ì—…ë¬´ ${r.workHours}h`;
      w.textContent = 'ğŸ›µ';
      icons.appendChild(w);
    }
    if (r.mood) {
      const m = document.createElement('span');
      m.textContent = ['','ğŸ˜','ğŸ˜•','ğŸ˜','ğŸ™‚','ğŸ˜„'][r.mood] || '';
      icons.appendChild(m);
    }
    if (icons.children.length) rows.appendChild(icons);

    card.appendChild(rows);
    grid.appendChild(card);
  }
}

/* â•â•â•â• WEEKLY CHART â•â•â•â• */
function renderWkChart(dates) {
  const chart = document.getElementById('wkChart'); chart.innerHTML = '';
  const dayN = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
  const maxV = Math.max(dynTarget * 1.5, ...dates.map(d => (weekData['d:'+d]||{}).income||0), 1);
  const td = today();

  for (const ds of dates) {
    const r = weekData['d:'+ds] || {}; const inc = r.income || 0;
    const barH = Math.max(2, Math.round(Math.min(1, inc / maxV) * 50));
    const tH   = Math.min(50, Math.round((dynTarget / maxV) * 50));
    const d = new Date(ds); const dow = d.getDay();

    const col = document.createElement('div'); col.className = 'wk-col'; col.onclick = () => selectDay(ds);
    const bar = document.createElement('div'); bar.className = 'wk-bar';
    bar.style.height = barH + 'px';
    bar.style.background = ds === curDate ? 'var(--gold)' : ds === td ? 'var(--teal)' : inc >= dynTarget ? 'var(--green)' : 'var(--bd2)';
    const tl = document.createElement('div'); tl.className = 'wk-tline';
    tl.style.bottom = (tH - barH) + 'px'; bar.appendChild(tl);
    const lbl = document.createElement('div'); lbl.className = 'wk-lbl';
    lbl.textContent = dayN[dow === 0 ? 6 : dow - 1];
    col.appendChild(bar); col.appendChild(lbl); chart.appendChild(col);
  }
}

/* â•â•â•â• SELECT DAY â•â•â•â• */
async function selectDay(ds) {
  curDate = ds;
  const d = new Date(ds);
  const mN = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  const dN = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  document.getElementById('panelDStr').textContent = `${d.getFullYear()}ë…„ ${mN[d.getMonth()]} ${d.getDate()}ì¼`;
  document.getElementById('panelDSub').textContent = dN[d.getDay()] + 'ìš”ì¼';
  document.getElementById('saveBtn').disabled = false;
  document.getElementById('saveBtn').textContent = 'ğŸ’¾  ì €ì¥';

  const r = weekData['d:' + ds] || {};

  // exercise
  exOn = r.exOn ? {...r.exOn} : {swim:false, run:false, bike:false};
  refreshExBtns();
  setV('swimLaps', r.swimLaps); setV('swimMin', r.swimMin); calcSwim();
  setV('runKm', r.runKm); setV('runMin', r.runMin); calcRun();
  setV('bikeKm', r.bikeKm); setV('bikeMin', r.bikeMin); calcBike();

  // income
  setV('todayIncome', r.income); setV('todayExpense', r.expense); setV('workHours', r.workHours);
  onIncome();

  // hobby
  setV('hobbyName', r.hobbyName); setV('hobbyHours', r.hobbyHours);

  // mood/note
  mood = r.mood || 0; refreshMoodBtns();
  document.getElementById('noteText').value = r.note || '';

  // Re-render accordion with today's data
  renderSubjectAccordion();

  renderCalendar(getWeekDates(wkOffset));
  renderWkChart(getWeekDates(wkOffset));
}

/* â•â•â•â• STUDY â•â•â•â• */
function onStudyH(subjId) {
  // Update preview
  const val = parseFloat(document.getElementById('s-' + subjId)?.value) || 0;
  const prev = document.getElementById('prev-' + subjId);
  if (prev) prev.textContent = val > 0 ? val + 'h' : '';
  // Recalc total
  let tot = 0;
  for (const s of SUBJECTS) tot += parseFloat(document.getElementById('s-'+s.id)?.value)||0;
  document.getElementById('studyTotal').innerHTML = tot.toFixed(1) + '<span style="font-size:11px;color:var(--muted);font-weight:400">h</span>';
  autoSave();
}

/* â•â•â•â• INCOME â•â•â•â• */
function onIncome() {
  const inc = parseFloat(document.getElementById('todayIncome')?.value) || 0;
  const exp = parseFloat(document.getElementById('todayExpense')?.value) || 0;
  const net = inc - exp;  // ì˜¤ëŠ˜ ìˆœìˆ˜ì…
  const tgt = dynTarget;  // ì˜¤ëŠ˜ ëª©í‘œ

  // ì˜¤ëŠ˜ ë‹¬ì„±ë¥  (ìˆœìˆ˜ì… ê¸°ì¤€)
  const pct = Math.min(100, Math.round((net / Math.max(tgt, 1)) * 100));

  // ì´ë²ˆë‹¬ ë¹„êµ (ì›”ë³„ ë¶€ì¡±/ì´ˆê³¼)
  const mTgt = monthlyTarget();
  const mInc = monthlyIncomeSoFar() + inc; // ì´ë²ˆë‹¬ ìˆ˜ì… (ì˜¤ëŠ˜ ì…ë ¥ í¬í•¨)
  const mGap = mInc - mTgt;

  document.getElementById('tEarned').textContent = krw(net);
  document.getElementById('tDynamic').textContent = krw(tgt);

  // 3ë²ˆ stat: ì´ë²ˆë‹¬ ê¸°ì¤€ ë¶€ì¡±/ì´ˆê³¼
  if (mGap >= 0) {
    document.getElementById('tGap').textContent = '+' + krw(mGap);
    document.getElementById('tGap').style.color = 'var(--green)';
    document.getElementById('tGapLbl').textContent = 'ì´ë²ˆë‹¬ ì´ˆê³¼';
  } else {
    document.getElementById('tGap').textContent = '-' + krw(Math.abs(mGap));
    document.getElementById('tGap').style.color = 'var(--red)';
    document.getElementById('tGapLbl').textContent = 'ì´ë²ˆë‹¬ ë¶€ì¡±';
  }

  document.getElementById('achPct').textContent = pct + '%';
  document.getElementById('achBar').style.width  = pct + '%';
  document.getElementById('achBar').style.background = net >= tgt ? 'var(--green)' : 'var(--gold)';
  document.getElementById('exceedNote').classList.toggle('show', net > tgt);
  autoSave();
}

/* â•â•â•â• EXERCISE METRICS â•â•â•â• */
function calcSwim() {
  const laps = parseFloat(document.getElementById('swimLaps')?.value) || 0;
  const min  = parseFloat(document.getElementById('swimMin')?.value) || 0;
  document.getElementById('swimMetric').textContent = (laps > 0 && min > 0) ? secToMS((min / laps) * 60) + '/lap' : 'â€”';
}
function calcRun() {
  const km  = parseFloat(document.getElementById('runKm')?.value) || 0;
  const min = parseFloat(document.getElementById('runMin')?.value) || 0;
  document.getElementById('runMetric').textContent = (km > 0 && min > 0) ? secToMS((min / km) * 60) + '/km' : 'â€”';
}
function calcBike() {
  const km  = parseFloat(document.getElementById('bikeKm')?.value) || 0;
  const min = parseFloat(document.getElementById('bikeMin')?.value) || 0;
  document.getElementById('bikeMetric').textContent = (km > 0 && min > 0) ? (km / (min / 60)).toFixed(1) + ' km/h' : 'â€”';
}

/* â•â•â•â• EXERCISE TOGGLE â•â•â•â• */
function toggleEx(t) { exOn[t] = !exOn[t]; refreshExBtns(); autoSave(); }
function refreshExBtns() {
  ['swim','run','bike'].forEach(t => {
    document.getElementById('ex' + t.charAt(0).toUpperCase() + t.slice(1)).className = 'ex-btn' + (exOn[t] ? ' on-' + t : '');
    document.getElementById('det-' + t).classList.toggle('show', exOn[t]);
  });
}

/* â•â•â•â• MOOD â•â•â•â• */
function setMood(n) { mood = n; refreshMoodBtns(); autoSave(); }
function refreshMoodBtns() { for (let i = 1; i <= 5; i++) document.getElementById('mood' + i).classList.toggle('on', i === mood); }

/* â•â•â•â• HOBBY â•â•â•â• */
let hobbyOpen = false;
function toggleHobbyBreakdown() {
  hobbyOpen = !hobbyOpen;
  document.getElementById('hobbyBreakdownPanel').classList.toggle('open', hobbyOpen);
  document.getElementById('hobbyArrow').style.transform = hobbyOpen ? 'rotate(90deg)' : '';
}
function updateHobbyDisplay() {
  document.getElementById('hobbyCumul').textContent = hobbyCumul.toFixed(1) + 'h';
  const panel = document.getElementById('hobbyBreakdownPanel');
  panel.innerHTML = '';
  const entries = Object.entries(hobbyBreakdown).sort((a, b) => b[1] - a[1]);
  if (!entries.length) { panel.innerHTML = '<div style="color:var(--muted);font-size:11px">ì•„ì§ ê¸°ë¡ëœ ì·¨ë¯¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
  const maxH = Math.max(...entries.map(e => e[1]));
  for (const [name, hrs] of entries) {
    const row = document.createElement('div'); row.className = 'hobby-bar-row';
    const pct = Math.max(5, Math.round((hrs / maxH) * 100));
    row.innerHTML = `
      <div class="hobby-bar-name" title="${name}">${name}</div>
      <div class="hobby-bar-track"><div class="hobby-bar-fill" style="width:${pct}%"></div></div>
      <div class="hobby-bar-hrs">${hrs.toFixed(1)}h</div>`;
    panel.appendChild(row);
  }
}

/* â•â•â•â• AUTO SAVE â•â•â•â• */
function autoSave() {
  clearTimeout(asTimer);
  asTimer = setTimeout(() => { if (curDate) saveRecord(true); }, 1800);
}

/* â•â•â•â• SAVE â•â•â•â• */
async function saveRecord(silent = false) {
  if (!curDate) return;
  // collect project progress from all subjects
  const projProgress = {};
  for (const subj of SUBJECTS) {
    for (const p of (subjectProjects[subj.id] || [])) {
      const inp = document.getElementById('pp-' + p.id);
      if (inp) projProgress[p.id] = parseFloat(inp.value) || 0;
    }
  }
  // collect study hours from accordion inputs
  const sKor  = parseFloat(document.getElementById('s-kor')?.value)  || 0;
  const sEng  = parseFloat(document.getElementById('s-eng')?.value)  || 0;
  const sMath = parseFloat(document.getElementById('s-math')?.value) || 0;
  const sSoc  = parseFloat(document.getElementById('s-soc')?.value)  || 0;

  const rec = {
    _type:'day', date:curDate,
    exOn:{...exOn},
    swimLaps:getN('swimLaps'), swimMin:getN('swimMin'),
    runKm:getN('runKm'), runMin:getN('runMin'),
    bikeKm:getN('bikeKm'), bikeMin:getN('bikeMin'),
    sKor, sEng, sMath, sSoc,
    income:getN('todayIncome'), expense:getN('todayExpense'), workHours:getN('workHours'),
    hobbyName:document.getElementById('hobbyName').value.trim(),
    hobbyHours:getN('hobbyHours'),
    mood, note:document.getElementById('noteText').value.trim(),
    projProgress,
    updatedAt:new Date().toISOString()
  };
  const st = document.getElementById('saveStatus');
  try {
    await dbSet('d:' + curDate, rec);
    weekData['d:' + curDate] = rec;
    if (!silent) { st.textContent = 'âœ“ ì €ì¥ ì™„ë£Œ'; setTimeout(() => st.textContent = '', 2000); }
    else { st.textContent = 'ìë™ì €ì¥'; setTimeout(() => st.textContent = '', 1500); }
    await loadAllTime();
    renderCalendar(getWeekDates(wkOffset));
    renderWkChart(getWeekDates(wkOffset));
    renderSubjectAccordion();
    // weekly summary
    let wInc=0,wStudy=0,wWork=0;
    for (const d of getWeekDates(wkOffset)) {
      const r = weekData['d:'+d]; if (!r) continue;
      wInc += (r.income||0); wWork += (r.workHours||0);
      wStudy += (r.sKor||0)+(r.sEng||0)+(r.sMath||0)+(r.sSoc||0);
    }
    document.getElementById('ws-study').textContent   = wStudy.toFixed(1)+'h';
    document.getElementById('ws-income').textContent  = krw(wInc);
    document.getElementById('ws-achieve').textContent = Math.round((wInc/(dynTarget*7))*100)+'%';
    document.getElementById('ws-work').textContent    = wWork.toFixed(1)+'h';
  } catch(e) { st.textContent = 'âš  ì €ì¥ ì‹¤íŒ¨'; console.error(e); }
}

/* â•â•â•â• HELPERS â•â•â•â• */
function getN(id) { return parseFloat(document.getElementById(id)?.value) || 0; }
function setV(id, v) { const el = document.getElementById(id); if (!el) return; el.value = (v == null || v === 0 || v === '') ? '' : v; }
function togglePanel() {
  const p = document.getElementById('rightPanel'), o = document.getElementById('overlay');
  p.classList.toggle('open'); o.style.display = p.classList.contains('open') ? 'block' : 'none';
}
function closePanel() {
  document.getElementById('rightPanel').classList.remove('open');
  document.getElementById('overlay').style.display = 'none';
}

/* â•â•â•â• INIT â•â•â•â• */
async function init() {
  initFB();
  await loadSubjectProjects();
  await renderWeek();
  const td = today();
  if (getWeekDates(0).includes(td)) await selectDay(td);
  const l = document.getElementById('loader');
  l.style.opacity = '0';
  setTimeout(() => l.style.display = 'none', 400);
}
init();
</script>
</body>
</html>
